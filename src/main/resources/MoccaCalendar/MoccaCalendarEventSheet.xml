<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>MoccaCalendar</web>
  <name>MoccaCalendarEventSheet</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>MoccaCalendarEventClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1383574876000</creationDate>
  <date>1385135945000</date>
  <contentUpdateDate>1385135945000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output="false"}}
### this macro shows a validation error message if it exists
#macro(showvalidationmessage $message $force)
#if($context.validationStatus.errors.contains($message) || "$!force" == "true") ##
&lt;font color="red"&gt;$xwiki.parseMessage($message)&lt;/font&gt;
#else ##
&amp;nbsp; ##
#end ##
#end ## end showvalidationmessage
##
#macro(displayDate $field)
#if($xcontext.getAction()=="view" &amp;&amp; $doc.getValue('allDay')==1)
  #set($format = $!doc.getObject('MoccaCalendar.MoccaCalendarEventClass').getxWikiClass().get($field).getProperty('dateFormat').value)
  #if($!format=="")
    #set($format = "dd.MM.yyyy")
  #end
  ## try to cut the time because this event has the all day flag 
  #set($idx=$format.indexOf("H"))
  #if($idx&gt;0)
    #set($format = $format.substring(0,$idx).trim())
  #end
#set($formattedValue = $escapetool.xml($datetool.format($format, $doc.getValue($field))))
$!formattedValue
#else
$doc.display($field)
#end
#end
##
#set($discard=$xwiki.jsx.use("MoccaCalendar.DatePickerExtension", {'defer': false}))
#set($calendar = $parentDoc.getObject('MoccaCalendar.MoccaCalendarClass'))
#if($calendar)
#set($calendarDoc = $xwiki.getDocument($parentDoc))
#end
#if(!$calendar &amp;&amp; "$!request.getParameter('parentFROM')" != "")
#set($calendarDoc = $xwiki.getDocument($request.getParameter('parentFROM')))
#set($calendar = $calendarDoc.getObject('MoccaCalendar.MoccaCalendarClass'))
#end
{{/velocity}}

{{velocity}}
{{html wiki="true"}}
#set($eventClass = 'MoccaCalendar.MoccaCalendarEventClass')
#set($eventValidationDoc = 'MoccaCalendar.MoccaCalendarEventValidation')
#set ($discard = $doc.use($eventClass))
#set ($discard = $services.localization.use('document', 'MoccaCalendar.MoccaCalendarTranslations'))
## add the groovy script to the validation (the xvalidation parameter in the request also works to set the groovy script validation)
#set ($discard =$doc.setValidationScript($eventValidationDoc))
## this will launch a validation on a document. All errors are added to the context
#set($isValid=$doc.validate())
## Valid: $isValid
(% class="xform" %)
&lt;input type="hidden" name="xvalidate" value="1" /&gt;
&lt;input type="hidden" name="xvalidation" value="$eventValidationDoc" /&gt;
(((
#if($xcontext.action=='view' &amp;&amp; $calendar)
  ; &lt;label for="calendar"&gt;$escapetool.xml($services.localization.render('MoccaCalendar.calendar'))&lt;/label&gt;
  : [[$escapetool.xml($calendarDoc.getDisplayTitle())&gt;&gt;$parentDoc.fullName]]
#elseif($xcontext.action=='edit' &amp;&amp; !$calendar)
#set($hql =", BaseObject as obj where doc.fullName=obj.name  and doc.name!='MoccaCalendarTemplate' and obj.className='MoccaCalendar.MoccaCalendarClass'")
  ; &lt;label for="calendar"&gt;$escapetool.xml($services.localization.render('MoccaCalendar.calendar'))&lt;/label&gt;
  : {{html}}
#set($started = false)
&lt;select name="parent"&gt;
#foreach($item in $xwiki.searchDocuments($hql))
#set($itemdoc = $xwiki.getDocument($item))
&lt;option value="$itemdoc"&gt;$itemdoc.getDisplayTitle()&lt;/option&gt;
#end
&lt;/select&gt;{{/html}}

#elseif($xcontext.action=='edit' &amp;&amp; $calendar)
 ; &lt;label for="calendar"&gt;$escapetool.xml($services.localization.render('MoccaCalendar.calendar'))&lt;/label&gt;
 : {{html}}&lt;input type="hidden" name="parent" value="$calendarDoc" /&gt; $xwiki.getDocument($calendarDoc).getDisplayTitle() {{/html}}

#end


  ; &lt;label for="MoccaCalendarEvent.MoccaCalendarEventClass_0_title"&gt;$escapetool.xml($doc.displayPrettyName('title', false, false))&lt;/label&gt;
  : $doc.display('title') #showvalidationmessage("val_title_already_exists") &lt;span class="val_title_notempty" style="display:none;"&gt;&lt;font color="red"&gt;$xwiki.parseMessage('val_title_notempty')&lt;/font&gt;&lt;/span&gt; &lt;span class="val_title_notvalid" style="display:none;"&gt;&lt;font color="red"&gt;$xwiki.parseMessage('val_title_notvalid')&lt;/font&gt;&lt;/span&gt;
  ; &lt;label for="MoccaCalendarEvent.MoccaCalendarEventClass_0_startDate"&gt;$escapetool.xml($doc.displayPrettyName('startDate', false, false))&lt;/label&gt;
  : #displayDate('startDate')
  ; &lt;label for="MoccaCalendarEvent.MoccaCalendarEventClass_0_endDate"&gt;$escapetool.xml($doc.displayPrettyName('endDate', false, false))&lt;/label&gt;
  : #displayDate('endDate')#showvalidationmessage("val_endDate")

  ; &lt;label for="MoccaCalendarEvent.MoccaCalendarEventClass_0_allDay"&gt;$escapetool.xml($doc.displayPrettyName('allDay', false, false))&lt;/label&gt;
  : $doc.display('allDay')

  ; &lt;label for="MoccaCalendarEvent.MoccaCalendarEventClass_0_description"&gt;$escapetool.xml($doc.displayPrettyName('description', false, false))&lt;/label&gt;
  : $doc.display('description')
)))

----

#if($xcontext.action=='view')
  #set($calendarDoc = $!request.getParameter('calendarDoc'))
  #if("$!calendarDoc" == "")
    #set($calendarDoc=$parentDoc)
  #end
#set($backToCalendar = $xwiki.getDocument($calendarDoc).getObject('MoccaCalendar.MoccaCalendarClass'))
#if($backToCalendar)
[[$services.localization.render('MoccaCalendar.calendarevent.backlink', $backToCalendar.getProperty('title').getValue()) &gt;&gt;$calendarDoc]]
#end
#end

{{/html}}

#if(($context.validationStatus.errors&amp;&amp;$context.validationStatus.errors.size()&gt;0))
$response.setStatus(400)
#end
{{/velocity}}</content>
</xwikidoc>

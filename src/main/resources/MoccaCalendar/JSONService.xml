<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>MoccaCalendar</web>
  <name>JSONService</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent/>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1377502319000</creationDate>
  <date>1373961627000</date>
  <contentUpdateDate>1373961627000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity filter="html" wiki="false"}}
#if($xcontext.action == 'get')
#if($xcontext.action == 'get' &amp;&amp; "$!{request.outputSyntax}" == 'plain')
  $response.setContentType('application/json')
#end

#if("$!{request.filter}"!="" &amp;&amp; "$!{request.calendarDoc}"!="")
#set($document = $xwiki.getDocument($request.calendarDoc))
#set($wherePageLocation ="")
#if("$!{request.filter}"=="page")
#set($wherePageLocation ="($wherePageLocation doc.fullName = '${request.calendarDoc}' or doc.parent='${request.calendarDoc}')")
#end
#if("$!{request.filter}"=="space")
#set($translated = $document.getTranslatedDocument())
##set($name = $translated.getName())
#set($space = $translated.getSpace())
#set($wherePageLocation ="doc.space = '$space'")
#end
#end
#if("$wherePageLocation" !="")
#set($wherePageLocation =" and $wherePageLocation")
#end

#if("$!{request.sql}"!="")
 #set($hql = $request.sql)
#else
 #set($hql =", BaseObject as obj $!{request.fromsql} where doc.fullName=obj.name $!{wherePageLocation} and doc.name!='MoccaCalendarEventTemplate' and obj.className='${request.classname}' $!{request.wheresql}")
#end
[
#set($started = false)
#foreach($item in $services.query.hql($hql).execute())
#set($itemdoc = $xwiki.getDocument($item))
#set($parentCalDocName=$itemdoc.getParent())
#if($parentCalDocName == "$!lastparentCalDocName")
#set($color="$!lastColor")
#else
#set($lastparentCalDocName = $parentCalDocName)
#set($color="$!xwiki.getDocument($parentCalDocName).getValue('color')")
#set($lastColor = $color)
#end
#set($startdate = $itemdoc.getValue($request.startfield))
#set($enddate = $itemdoc.getValue($request.endfield))
#set($duration = $itemdoc.getValue($request.durationfield))
#if(!$duration)
 #set($duration = "30")
#end
#if($startdate)
#if($enddate)
#set($enddate =$xwiki.jodatime.getDateTime($enddate.getTime()))
#else
#set($enddate = $xwiki.jodatime.getDateTime($startdate.getTime()))
#set($enddate = $enddate.plusMinutes($util.parseInt($duration)))
#end
#if($started)
,
#else
#set($started = true)
#end
#set($allDay=false)
#if("$!itemdoc.getValue('allDay')"==1)
#set($allDay=true)
#end
{ "id" : "${escapetool.javascript($itemdoc.fullName)}", "title" : "${escapetool.javascript($itemdoc.getPlainTitle())}", "url" : "${escapetool.javascript($itemdoc.getURL('view',"calendarDoc=$!request.calendarDoc"))}", "start" : "$!{xwiki.formatDate($startdate, "yyyy-MM-dd'T'HH:mm")}", "end" : "$!{xwiki.formatDate($enddate.toDate(), "yyyy-MM-dd'T'HH:mm")}","allDay":$allDay, "color":"$color" }
#end
#end
]
#else
Service Page for the Mocca Calendar Application
#end ## end of #if($xcontext.action == 'get')
{{/velocity}}</content>
</xwikidoc>
